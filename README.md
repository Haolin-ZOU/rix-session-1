
# rix-session-1 — Reproducible R + Python dev environment with Nix + {rix} + direnv (and Git basics)

This repository is a hands-on implementation of RAP4MADS:

- **Chapter 1**: Reproducibility with **Nix** + **{rix}** (generate a pinned `default.nix`) and **direnv + nix-direnv** (auto-load the Nix dev shell when entering a project directory)
- **Chapter 2**: Version control basics with **Git** (repo creation, clone, commit, push, and common commands)

**Tested on:** macOS (Darwin 24.x)  
**Other OS:** Follow the official guides below for platform-specific notes.

## References (official guides)

- **Building Reproducible Analytical Pipelines — Reproducibility with Nix**  
  https://rap4mads.eu/02-intro-nix.html
- **Building Reproducible Analytical Pipelines — Git**  
  https://rap4mads.eu/03-git.html

---

## Repository layout

```

.
├── project1/
│   ├── gen-env.R        # {rix} configuration used to generate default.nix
│   ├── default.nix      # generated by {rix}; pinned nixpkgs snapshot by date
│   ├── .envrc           # direnv entrypoint (loads the Nix shell)
│   └── .Rprofile        # generated by {rix} (may be present)
├── rix/                 # Chapter 1 work done before the "start a new project" step
├── analysis.R           # simple R example (Chapter 2 practice content)
├── hello.py             # simple Python example (Chapter 2 practice content)
├── .gitignore
└── README.md

````

### How this maps to Chapter 1 of the book

During Chapter 1, there is a point where the guide says:

> “To start a new project, create a new directory, and cd into it. Then, in that folder, create a new script called gen-env.R and add the following: …”

In this repo:

- Work **before** that “start a new project” step is stored under **`rix/`**
- The “new project folder” created after that step is **`project1/`**, which contains `gen-env.R`, `default.nix`, and `.envrc`

---

# Chapter 1 — Reproducibility with Nix

## 1) One-time (global) setup on a machine

### 1.1 Install Nix
Install Nix for your system (use the official installer). After installation, open a new terminal.

### 1.2 Install direnv and nix-direnv
Install both tools globally so they can be used across projects:

```bash
nix-env -f '<nixpkgs>' -iA direnv
nix-env -f '<nixpkgs>' -iA nix-direnv
````

### 1.3 Enable the direnv shell hook (zsh example)

Add this line to your `~/.zshrc`:

```bash
eval "$(direnv hook zsh)"
```

Then reload your shell:

```bash
source ~/.zshrc
```

### 1.4 Enable nix-direnv integration

Create the direnv config folder and source nix-direnv’s `direnvrc`:

```bash
mkdir -p ~/.config/direnv
echo 'source "$HOME/.nix-profile/share/nix-direnv/direnvrc"' >> ~/.config/direnv/direnvrc
```

---

## 2) Create a new project with {rix} (workflow used in `project1/`)

### 2.1 Create a project folder

```bash
mkdir -p ~/RAP4MADS/project1
cd ~/RAP4MADS/project1
```

### 2.2 Write `gen-env.R`

This script defines the environment and generates `default.nix`:

```r
library(rix)

rix(
  date = "2025-09-22",
  r_pkgs = c("languageserver", "tidyverse"),
  py_conf = list(
    py_version = "3.13",
    py_pkgs = c("polars", "great-tables")
  ),
  ide = "none",
  project_path = ".",
  overwrite = TRUE,
  print = TRUE
)
```

### 2.3 Run {rix} in a temporary shell and generate `default.nix`

Start a temporary shell that provides R + {rix}:

```bash
nix-shell -I nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/refs/heads/2025-09-22.tar.gz -p R rPackages.rix
```

Inside that shell, start R:

```bash
R
```

In R:

```r
library(rix)
source("gen-env.R")
q("no")
```

Exit the temporary shell:

```bash
exit
```

You should now have `default.nix` in the project directory.

---

## 3) Build the environment (`nix-build`)

From the project directory:

```bash
nix-build
```

---

## 4) Automatically load the environment with direnv (`.envrc`)

Create `.envrc`:

```bash
printf "use nix\n" > .envrc
```

Allow direnv to load it:

```bash
direnv allow
```

If you modify `.envrc` later, re-allow/reload:

```bash
direnv allow
direnv reload
```

---

## 5) Verify the environment

Run the following in the project directory:

```bash
echo "$IN_NIX_SHELL"
which R
which python
python -c "import polars, great_tables; print('Py ok')"
```

Expected:

* `IN_NIX_SHELL` is set (commonly `impure`)
* `R` and `python` resolve to `/nix/store/...`
* `Py ok` prints successfully

---

## 6) 1.4.3 Summary and next steps (how to repeat for new projects)

For every new project, repeat:

1. Generate `default.nix` with `{rix}` (via `gen-env.R`)
2. Build with `nix-build`
3. Create `.envrc` with `use nix`
4. Approve it once (`direnv allow`)
5. Work inside the directory (direnv auto-loads the environment)

Two equivalent ways to “Allow” the `.envrc`:

* **IDE-first method (VS Code / Positron):**

  1. Open the project folder in the IDE
  2. Click **Allow** when prompted for `.envrc`
  3. Restart the extension/IDE if required

* **Terminal-first method (no IDE prompt):**

  1. Create `.envrc` with `use nix`
  2. In a terminal, `cd` into the project folder
  3. Run `direnv allow`
  4. Then open the folder in the IDE (usually no prompt)

For OS-specific notes, always refer to:
[https://rap4mads.eu/02-intro-nix.html](https://rap4mads.eu/02-intro-nix.html)

---

# Chapter 2 — Git (version control practice)

This repository also follows RAP4MADS Chapter 2:
[https://rap4mads.eu/03-git.html](https://rap4mads.eu/03-git.html)

## 1) Clone the repository (SSH)

On GitHub:

* Click **Code** → **SSH**
* Copy the SSH URL

Then on your machine:

```bash
git clone <ssh-url>
cd rix-session-1
```

## 2) Common Git commands used in this repo

Check status:

```bash
git status
```

Stage and commit:

```bash
git add <files-or-folders>
git commit -m "Meaningful message"
```

View commit history:

```bash
git log --oneline -5
```

Push to GitHub:

```bash
git push origin main
```

Pull updates:

```bash
git pull origin main
```

## 3) Files added during Chapter 2 practice

* `hello.py` and `analysis.R` are minimal examples added to practice committing and pushing changes.
* `.gitignore` is included to avoid committing typical local/temporary artifacts.

---
