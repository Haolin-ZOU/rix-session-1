
# rix-session-1 — Reproducible R + Python dev environment with Nix + {rix} + direnv

This repository is a hands-on implementation of RAP4MADS Chapter 1: using **Nix** + **{rix}** to generate a reproducible `default.nix`, and **direnv + nix-direnv** to automatically load the Nix development shell when you enter the project directory.

**Tested on:** macOS (Darwin 24.x).  
**Other OS:** Please follow the same workflow using the official guide below (it contains platform-specific notes).

**Reference (official guide):**  
Building Reproducible Analytical Pipelines-Reproducibility with Nix  
`https://rap4mads.eu/02-intro-nix.html`

---

## Repository layout


```
.
├── project1/
│   ├── gen-env.R        # {rix} configuration used to generate default.nix
│   ├── default.nix      # generated by {rix}; pinned nixpkgs snapshot by date
│   ├── .envrc           # direnv entrypoint (loads the Nix shell)
│   └── .Rprofile        # generated by {rix} (may be present)
└── README.md
```


---

## 1) One-time (global) setup on a machine

### 1.1 Install Nix
Install Nix for your system (see Nix official installer). After installation, open a new terminal.

### 1.2 Install direnv and nix-direnv
Install both tools globally so they can be used across projects:

```bash
nix-env -f '<nixpkgs>' -iA direnv
nix-env -f '<nixpkgs>' -iA nix-direnv
````

### 1.3 Enable the direnv shell hook (zsh example)

Add this line to your `~/.zshrc`:

```bash
eval "$(direnv hook zsh)"
```

Then reload your shell:

```bash
source ~/.zshrc
```

### 1.4 Enable nix-direnv integration

Create the direnv config folder and source nix-direnv’s `direnvrc`:

```bash
mkdir -p ~/.config/direnv
echo 'source "$HOME/.nix-profile/share/nix-direnv/direnvrc"' >> ~/.config/direnv/direnvrc
```

---

## 2) Create a new project with {rix} (workflow used in `project1/`)

### 2.1 Create a project folder

```bash
mkdir -p ~/RAP4MADS/project1
cd ~/RAP4MADS/project1
```

### 2.2 Write `gen-env.R`

This script defines the environment and generates `default.nix`:

```r
library(rix)

rix(
  date = "2025-09-22",
  r_pkgs = c("languageserver", "tidyverse"),
  py_conf = list(
    py_version = "3.13",
    py_pkgs = c("polars", "great-tables")
  ),
  ide = "none",
  project_path = ".",
  overwrite = TRUE,
  print = TRUE
)
```

### 2.3 Run {rix} in a temporary shell and generate `default.nix`

Start a temporary shell that provides R + {rix}:

```bash
nix-shell -I nixpkgs=https://github.com/rstats-on-nix/nixpkgs/archive/refs/heads/2025-09-22.tar.gz -p R rPackages.rix
```

Inside that shell:

```bash
R
```

In R:

```r
library(rix)
source("gen-env.R")
q("no")
```

Exit the temporary shell:

```bash
exit
```

You should now have `default.nix` in the project directory.

---

## 3) Build the environment (`nix-build`)

From the project directory:

```bash
nix-build
```

---

## 4) Automatically load the environment with direnv (`.envrc`)

Create `.envrc`:

```bash
printf "use nix\n" > .envrc
```

> On macOS, you do not need the `mkdir $TMP` line shown in some examples.

Allow direnv to load it:

```bash
direnv allow
```

If you modify `.envrc` later, re-allow/reload:

```bash
direnv allow
direnv reload
```

---

## 5) Verify the environment

Run the following in the project directory:

```bash
echo "$IN_NIX_SHELL"
which R
which python
python -c "import polars, great_tables; print('Py ok')"
```

Expected:

* `IN_NIX_SHELL` is set (commonly `impure`)
* `R` and `python` resolve to `/nix/store/...`
* `Py ok` prints successfully

---

## 6) 1.4.3 Summary and next steps (how to repeat for new projects)

For every new project, repeat:

1. Generate `default.nix` with `{rix}` (via `gen-env.R`)
2. Build with `nix-build`
3. Create `.envrc` with `use nix`
4. Approve it once (Allow)
5. Work inside the directory (direnv auto-loads the environment)

Two equivalent ways to “Allow” the `.envrc`:

* **IDE-first method (VS Code / Positron):**

  1. Open the project folder in the IDE
  2. Click **Allow** when prompted for `.envrc`
  3. Restart the extension/IDE if required

* **Terminal-first method (no IDE prompt):**

  1. Create `.envrc` with `use nix`
  2. In a terminal, `cd` into the project folder
  3. Run `direnv allow`
  4. Then open the folder in the IDE (usually no prompt)

For OS-specific notes, always refer to:
`https://rap4mads.eu/02-intro-nix.html`

```
::contentReference[oaicite:0]{index=0}
```
